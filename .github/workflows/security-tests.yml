name: Security Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-tests:
    name: Security Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          pip install safety pip-audit bandit semgrep || true
      
      - name: Run penetration tests
        run: |
          pytest tests/security/test_penetration.py -v --tb=short || true
      
      - name: Run dependency scanning tests
        run: |
          pytest tests/security/test_dependency_scanning.py -v --tb=short || true
      
      - name: Run SAST tests
        run: |
          pytest tests/security/test_sast.py -v --tb=short || true
      
      - name: Run DAST tests
        run: |
          pytest tests/security/test_dast.py -v --tb=short || true
      
      - name: Run infrastructure security tests
        run: |
          pytest tests/security/test_infrastructure.py -v --tb=short || true
      
      - name: Run security audit tests
        run: |
          pytest tests/security/test_audit.py -v --tb=short || true
      
      - name: Run Safety (CVE scanning)
        continue-on-error: true
        run: |
          safety check --json || safety check || echo "Safety not available"
      
      - name: Run pip-audit
        continue-on-error: true
        run: |
          pip-audit --format json || pip-audit || echo "pip-audit not available"
      
      - name: Run Bandit (SAST)
        continue-on-error: true
        run: |
          bandit -r src/ -f json -o bandit-report.json || bandit -r src/ || echo "Bandit not available"
      
      - name: Generate security report
        run: |
          python tests/security/security_runner.py || echo "Security runner completed"
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            security_test_report.json
            bandit-report.json
          retention-days: 30
      
      - name: Security test summary
        if: always()
        run: |
          echo "## Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f security_test_report.json ]; then
            echo "Security tests completed. Check artifacts for detailed report." >> $GITHUB_STEP_SUMMARY
          else
            echo "Security test report not generated." >> $GITHUB_STEP_SUMMARY
          fi

  dependency-scanning:
    name: Dependency Vulnerability Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Safety check
        continue-on-error: true
        run: |
          pip install safety
          safety check --json > safety-report.json || safety check || echo "No vulnerabilities found or Safety not available"
      
      - name: Run pip-audit
        continue-on-error: true
        run: |
          pip install pip-audit
          pip-audit --format json > pip-audit-report.json || pip-audit || echo "No vulnerabilities found or pip-audit not available"
      
      - name: Upload dependency scan reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dependency-scan-reports
          path: |
            safety-report.json
            pip-audit-report.json
          retention-days: 30

  sast-scanning:
    name: Static Application Security Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Bandit
        run: |
          pip install bandit
      
      - name: Run Bandit scan
        continue-on-error: true
        run: |
          bandit -r src/ -f json -o bandit-sast-report.json || \
          bandit -r src/ -o bandit-sast-report.txt || \
          echo "Bandit scan completed"
      
      - name: Install Semgrep
        continue-on-error: true
        run: |
          pip install semgrep || echo "Semgrep not available"
      
      - name: Run Semgrep scan
        continue-on-error: true
        run: |
          semgrep --config=auto --json -o semgrep-report.json src/ || \
          semgrep --config=auto src/ || \
          echo "Semgrep scan completed"
      
      - name: Upload SAST reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: sast-reports
          path: |
            bandit-sast-report.json
            bandit-sast-report.txt
            semgrep-report.json
          retention-days: 30

  container-security:
    name: Container Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name != 'schedule'  # Skip on schedule to avoid unnecessary runs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for Dockerfile
        id: check_dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Trivy
        if: steps.check_dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          trivy_version: 'latest'
      
      - name: Run Trivy vulnerability scanner
        if: steps.check_dockerfile.outputs.exists == 'true'
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results
        if: steps.check_dockerfile.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v3
        with:
          name: trivy-scan-results
          path: trivy-results.sarif
          retention-days: 30

