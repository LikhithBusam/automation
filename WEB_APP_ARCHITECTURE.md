# Web Application Architecture - Production Level

**Project:** AutoGen Development Assistant Web Application
**Version:** 3.0.0 (Web Edition)
**Date:** 2025-12-31

---

## Executive Summary

This document details the architecture for adding a production-grade web application to the existing CLI-based AutoGen Development Assistant. The web app will provide a modern, browser-based interface while reusing 100% of the existing AutoGen core logic.

**Key Principles:**
- ✅ Reuse existing CLI core (zero code duplication)
- ✅ RESTful API design with WebSocket for real-time updates
- ✅ Modern React frontend with TypeScript
- ✅ Production-ready authentication & authorization
- ✅ Horizontal scalability from day one

---

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                     USERS & CLIENTS                              │
│  Web Browser │ Mobile App │ VS Code Extension │ CI/CD Pipeline  │
└────────────────────────┬────────────────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────────────────┐
│                    NGINX Load Balancer                           │
│              SSL Termination │ Rate Limiting                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
┌───────▼──────┐  ┌──────▼──────┐  ┌─────▼───────┐
│  React SPA   │  │  React SPA  │  │  React SPA  │
│  (Static)    │  │  (Static)   │  │  (Static)   │
└──────────────┘  └─────────────┘  └─────────────┘
        │                │                │
┌───────▼──────────────────────────────────────────┐
│            FastAPI Backend Cluster                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ Instance │  │ Instance │  │ Instance │       │
│  │    1     │  │    2     │  │    3     │       │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
│       │             │             │              │
│       └─────────────┼─────────────┘              │
│                     │                            │
│  ┌──────────────────▼──────────────────┐        │
│  │   Existing CLI Core (main.py)       │        │
│  │                                      │        │
│  │  ┌────────────────────────────┐     │        │
│  │  │ ConversationManager        │     │        │
│  │  │   (AutoGen Orchestrator)   │     │        │
│  │  └────────────┬───────────────┘     │        │
│  │               │                      │        │
│  │  ┌────────────▼───────────────┐     │        │
│  │  │    AgentFactory            │     │        │
│  │  │  (8 Specialized Agents)    │     │        │
│  │  └────────────┬───────────────┘     │        │
│  │               │                      │        │
│  │  ┌────────────▼───────────────┐     │        │
│  │  │    MCPToolManager          │     │        │
│  │  └────────────┬───────────────┘     │        │
│  └───────────────┼─────────────────────┘        │
└────────────────────┼──────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
┌───────▼──────┐ ┌──▼────────┐ ┌▼────────────┐
│ MCP Servers  │ │ PostgreSQL│ │    Redis    │
│ (Ports       │ │ (Primary  │ │  (Cache +   │
│ 3000-3004)   │ │  DB)      │ │   Queue)    │
└──────────────┘ └───────────┘ └─────────────┘
```

---

## Technology Stack

### Frontend
- **Framework:** React 18.3+ with TypeScript 5.3+
- **Build Tool:** Vite 5.x (fast HMR, optimized builds)
- **State Management:** Zustand (lightweight, no boilerplate)
- **UI Library:** shadcn/ui + Tailwind CSS 3.4+
- **Code Editor:** Monaco Editor (VS Code engine)
- **HTTP Client:** Axios + React Query (caching, retry)
- **WebSocket:** Socket.io-client (real-time updates)
- **Routing:** React Router v6
- **Forms:** React Hook Form + Zod validation
- **Charts:** Recharts (analytics dashboards)

### Backend
- **Framework:** FastAPI 0.109+ (async Python)
- **ASGI Server:** Uvicorn with Gunicorn workers
- **Authentication:** JWT (PyJWT) + OAuth2 (Google, GitHub)
- **WebSocket:** FastAPI WebSocket + Socket.io
- **Database ORM:** SQLAlchemy 2.0+ (async)
- **Migrations:** Alembic
- **Task Queue:** Celery + Redis (background jobs)
- **Caching:** Redis (response caching, sessions)
- **API Docs:** OpenAPI 3.1 (auto-generated by FastAPI)

### Database & Storage
- **Primary DB:** PostgreSQL 15+ (production data)
- **Cache:** Redis 7+ (sessions, job queue, real-time)
- **File Storage:** MinIO / S3 (uploaded code, reports)
- **Search:** ElasticSearch (optional - code search)

### Infrastructure
- **Containers:** Docker + Docker Compose
- **Orchestration:** Kubernetes (existing Helm charts)
- **Reverse Proxy:** NGINX
- **Monitoring:** Prometheus + Grafana (existing)
- **Logging:** ELK Stack (existing)
- **CI/CD:** GitHub Actions (existing)

---

## API Architecture

### API Design Principles
1. RESTful resources with standard HTTP methods
2. Stateless (JWT for authentication)
3. Versioned API (`/api/v1/...`)
4. Consistent error responses
5. Rate limiting per user/endpoint
6. Comprehensive OpenAPI documentation

### API Endpoints

#### Authentication & Users
```
POST   /api/v1/auth/register           # Register new user
POST   /api/v1/auth/login              # Login (email/password)
POST   /api/v1/auth/login/google       # OAuth2 Google
POST   /api/v1/auth/login/github       # OAuth2 GitHub
POST   /api/v1/auth/refresh            # Refresh JWT token
POST   /api/v1/auth/logout             # Logout (invalidate token)
GET    /api/v1/users/me                # Get current user profile
PATCH  /api/v1/users/me                # Update profile
GET    /api/v1/users/me/stats          # User statistics
```

#### Workflows
```
GET    /api/v1/workflows               # List available workflows
GET    /api/v1/workflows/{name}        # Get workflow details
POST   /api/v1/workflows/{name}/execute # Execute workflow
GET    /api/v1/workflows/history       # User's workflow history
GET    /api/v1/workflows/history/{id}  # Get specific execution
DELETE /api/v1/workflows/history/{id}  # Delete execution
```

#### Code Review (Primary Feature)
```
POST   /api/v1/code-review             # Submit code for review
GET    /api/v1/code-review/{job_id}    # Get review status
GET    /api/v1/code-review/{job_id}/results # Get review results
DELETE /api/v1/code-review/{job_id}    # Cancel review
GET    /api/v1/code-review/history     # User's review history
```

#### Projects
```
GET    /api/v1/projects                # List user's projects
POST   /api/v1/projects                # Create new project
GET    /api/v1/projects/{id}           # Get project details
PATCH  /api/v1/projects/{id}           # Update project
DELETE /api/v1/projects/{id}           # Delete project
GET    /api/v1/projects/{id}/reviews   # Project reviews
```

#### Analytics & Monitoring
```
GET    /api/v1/analytics/overview      # Dashboard overview
GET    /api/v1/analytics/cost          # Cost tracking
GET    /api/v1/analytics/usage         # API usage stats
GET    /api/v1/analytics/agents        # Agent performance
```

#### System
```
GET    /api/v1/health                  # Health check
GET    /api/v1/version                 # API version
GET    /api/v1/docs                    # OpenAPI documentation
WS     /api/v1/ws/{job_id}             # WebSocket for real-time updates
```

### Request/Response Examples

#### POST /api/v1/code-review
**Request:**
```json
{
  "code": "def hello():\n    print('Hello World')\n",
  "language": "python",
  "focus_areas": ["security", "performance"],
  "workflow": "quick_code_review",
  "project_id": "proj_123"
}
```

**Response (202 Accepted):**
```json
{
  "job_id": "job_abc123",
  "status": "queued",
  "created_at": "2025-12-31T12:00:00Z",
  "estimated_duration": 5,
  "websocket_url": "/api/v1/ws/job_abc123"
}
```

#### GET /api/v1/code-review/{job_id}/results
**Response (200 OK):**
```json
{
  "job_id": "job_abc123",
  "status": "completed",
  "workflow": "quick_code_review",
  "duration_seconds": 3.47,
  "results": {
    "summary": "Code quality: 8/10. Found 2 security issues.",
    "issues": [
      {
        "severity": "high",
        "category": "security",
        "line": 2,
        "message": "Potential SQL injection risk",
        "suggestion": "Use parameterized queries"
      }
    ],
    "metrics": {
      "code_quality": 8,
      "security_score": 6,
      "performance_score": 9
    }
  },
  "created_at": "2025-12-31T12:00:00Z",
  "completed_at": "2025-12-31T12:00:03Z"
}
```

#### WebSocket Events (WS /api/v1/ws/{job_id})
```json
// Connected
{"type": "connected", "job_id": "job_abc123"}

// Progress updates
{"type": "progress", "step": "analyzing", "percent": 25}
{"type": "progress", "step": "security_check", "percent": 50}

// Agent messages
{"type": "agent_message", "agent": "code_analyzer", "message": "Found 5 issues"}

// Completion
{"type": "completed", "status": "success", "results": {...}}

// Error
{"type": "error", "message": "Workflow timeout"}
```

---

## Database Schema

### Users Table
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255),  -- NULL for OAuth users
    full_name VARCHAR(100),
    avatar_url VARCHAR(500),
    role VARCHAR(20) DEFAULT 'user',  -- 'user', 'admin'
    oauth_provider VARCHAR(20),  -- 'google', 'github', NULL
    oauth_id VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    email_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    last_login TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_oauth ON users(oauth_provider, oauth_id);
```

### Projects Table
```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    repository_url VARCHAR(500),
    language VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_projects_user ON projects(user_id);
```

### Workflow Executions Table
```sql
CREATE TABLE workflow_executions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    project_id UUID REFERENCES projects(id) ON DELETE SET NULL,
    workflow_name VARCHAR(100) NOT NULL,
    status VARCHAR(20) NOT NULL,  -- 'queued', 'running', 'completed', 'failed'
    input_data JSONB NOT NULL,
    results JSONB,
    error_message TEXT,
    duration_seconds FLOAT,
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE INDEX idx_executions_user ON workflow_executions(user_id);
CREATE INDEX idx_executions_status ON workflow_executions(status);
CREATE INDEX idx_executions_created ON workflow_executions(created_at DESC);
```

### Code Reviews Table
```sql
CREATE TABLE code_reviews (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    execution_id UUID REFERENCES workflow_executions(id) ON DELETE CASCADE,
    code_content TEXT NOT NULL,
    language VARCHAR(50),
    file_path VARCHAR(500),
    focus_areas TEXT[],
    issues_found JSONB,
    metrics JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_reviews_execution ON code_reviews(execution_id);
```

### API Keys Table (for programmatic access)
```sql
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    key_hash VARCHAR(255) UNIQUE NOT NULL,
    key_prefix VARCHAR(10) NOT NULL,  -- First 8 chars for display
    scopes TEXT[],  -- ['read', 'write', 'execute']
    last_used_at TIMESTAMP,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_api_keys_user ON api_keys(user_id);
CREATE INDEX idx_api_keys_hash ON api_keys(key_hash);
```

---

## Security Architecture

### Authentication Flow
```
1. User Registration:
   Email/Password → Bcrypt Hash → Store in DB → Send verification email

2. OAuth Flow (Google/GitHub):
   Redirect to OAuth → Get authorization code → Exchange for tokens
   → Get user info → Create/update user → Generate JWT

3. Login:
   Email/Password → Verify bcrypt → Generate JWT (access + refresh)
   → Return tokens to client

4. Authenticated Requests:
   Client sends: Authorization: Bearer <access_token>
   → Server validates JWT → Extract user_id → Process request

5. Token Refresh:
   Client sends refresh_token → Validate → Issue new access_token
```

### Authorization Levels
```
PUBLIC:     No authentication required
AUTHENTICATED: Valid JWT token required
ADMIN:      role='admin' required
```

### Security Features
1. **Password Security:**
   - Bcrypt hashing (cost factor 12)
   - Password strength validation (min 8 chars, mixed case, numbers)
   - Rate limiting on login attempts (5 attempts/15 min)

2. **JWT Tokens:**
   - Short-lived access tokens (15 minutes)
   - Long-lived refresh tokens (7 days)
   - Signed with RS256 (asymmetric keys)
   - Stored in httpOnly cookies (XSS protection)

3. **API Security:**
   - Rate limiting per user (100 req/min)
   - Request size limits (10MB max)
   - CORS whitelist
   - SQL injection prevention (SQLAlchemy ORM)
   - XSS prevention (input sanitization)

4. **Data Protection:**
   - HTTPS only (TLS 1.3)
   - Encrypted database connections
   - Sensitive data encrypted at rest
   - PII logging redaction

---

## Frontend Architecture

### Directory Structure
```
frontend/
├── public/
│   ├── favicon.ico
│   └── index.html
├── src/
│   ├── components/
│   │   ├── common/
│   │   │   ├── Button.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Modal.tsx
│   │   │   └── Spinner.tsx
│   │   ├── layout/
│   │   │   ├── Header.tsx
│   │   │   ├── Sidebar.tsx
│   │   │   └── Footer.tsx
│   │   ├── code/
│   │   │   ├── CodeEditor.tsx      # Monaco editor
│   │   │   ├── ReviewResult.tsx
│   │   │   └── IssueCard.tsx
│   │   └── dashboard/
│   │       ├── StatsCard.tsx
│   │       ├── RecentReviews.tsx
│   │       └── UsageChart.tsx
│   ├── pages/
│   │   ├── Home.tsx
│   │   ├── Login.tsx
│   │   ├── Register.tsx
│   │   ├── Dashboard.tsx
│   │   ├── CodeReview.tsx
│   │   ├── Projects.tsx
│   │   ├── History.tsx
│   │   └── Settings.tsx
│   ├── hooks/
│   │   ├── useAuth.ts
│   │   ├── useCodeReview.ts
│   │   ├── useWebSocket.ts
│   │   └── useProjects.ts
│   ├── services/
│   │   ├── api.ts                  # Axios instance
│   │   ├── auth.service.ts
│   │   ├── workflow.service.ts
│   │   └── websocket.service.ts
│   ├── store/
│   │   ├── authStore.ts            # Zustand auth state
│   │   ├── reviewStore.ts
│   │   └── uiStore.ts
│   ├── types/
│   │   ├── api.types.ts
│   │   ├── user.types.ts
│   │   └── workflow.types.ts
│   ├── utils/
│   │   ├── constants.ts
│   │   ├── formatters.ts
│   │   └── validators.ts
│   ├── App.tsx
│   ├── main.tsx
│   └── router.tsx
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.js
```

### Key Pages

#### 1. Dashboard
- Overview statistics (reviews done, issues found, cost)
- Recent code reviews (quick access)
- Usage charts (daily/weekly trends)
- Quick action buttons (New Review, New Project)

#### 2. Code Review Page
- Monaco code editor (syntax highlighting)
- Language selector
- Focus areas checkboxes (security, performance, etc.)
- Submit button → Real-time progress
- Results display (issues, metrics, suggestions)

#### 3. Projects Page
- Project list with search/filter
- Create new project modal
- Project cards (name, language, last review)
- Click → Project details page

#### 4. History Page
- Table of all workflow executions
- Filters (date range, workflow type, status)
- Pagination
- Click row → View results

#### 5. Settings Page
- Profile (name, email, avatar)
- API keys management
- Notification preferences
- Theme toggle (light/dark)

---

## Real-Time Architecture

### WebSocket Flow
```
1. Client connects: ws://api.example.com/api/v1/ws/{job_id}
2. Server authenticates via query param: ?token=<jwt>
3. Client subscribes to job updates
4. Backend emits events:
   - progress updates (every agent step)
   - agent messages (streaming logs)
   - completion (final results)
5. Client disconnects when job completes
```

### Event Types
```typescript
type WebSocketEvent =
  | { type: 'connected'; job_id: string }
  | { type: 'progress'; step: string; percent: number }
  | { type: 'agent_message'; agent: string; message: string }
  | { type: 'completed'; status: 'success' | 'failed'; results?: any }
  | { type: 'error'; message: string };
```

---

## Deployment Architecture

### Development Environment
```
docker-compose up
  ├── nginx (localhost:80)
  ├── frontend (Vite dev server :5173)
  ├── backend (FastAPI :8000)
  ├── postgres (localhost:5432)
  ├── redis (localhost:6379)
  └── 4 MCP servers (ports 3000-3004)
```

### Production Environment (Kubernetes)
```
Ingress (NGINX)
  ├── /           → Frontend (React static files)
  ├── /api/v1/*   → Backend Service (3 replicas)
  └── /ws/*       → Backend Service (WebSocket)

Backend Deployment
  ├── Pod 1 (FastAPI + CLI core)
  ├── Pod 2 (FastAPI + CLI core)
  └── Pod 3 (FastAPI + CLI core)

StatefulSets
  ├── PostgreSQL (Primary + Replica)
  └── Redis (Cluster mode)

MCP Servers (Existing deployment)
  ├── GitHub Server
  ├── Filesystem Server
  ├── Memory Server
  └── CodeBaseBuddy Server
```

---

## Performance Optimization

### Backend
1. **Response Caching** (Redis)
   - Cache workflow metadata (5 min)
   - Cache user profile (1 min)
   - Cache-Control headers

2. **Database Optimization**
   - Connection pooling (max 20 connections)
   - Query optimization (indexes)
   - Read replicas for analytics

3. **Async Processing**
   - Celery for long-running workflows
   - Background tasks (email, cleanup)

4. **Rate Limiting**
   - Redis-based sliding window
   - Per-user quotas

### Frontend
1. **Code Splitting**
   - Route-based lazy loading
   - Dynamic imports for heavy components

2. **Asset Optimization**
   - Vite build optimization
   - Image compression
   - CDN for static assets

3. **Caching**
   - React Query caching (5 min stale time)
   - Service Worker (PWA)

4. **Bundle Size**
   - Tree shaking
   - Monaco editor loaded on-demand
   - Target: < 300KB initial bundle

---

## Monitoring & Observability

### Metrics (Prometheus)
```
# API Metrics
- http_requests_total
- http_request_duration_seconds
- http_active_requests

# Business Metrics
- code_reviews_total
- workflow_executions_total
- active_users_count

# System Metrics
- cpu_usage_percent
- memory_usage_bytes
- db_connections_active
```

### Dashboards (Grafana)
1. **API Performance** - Request latency, throughput, errors
2. **User Activity** - Active users, reviews/day, workflow usage
3. **System Health** - CPU, memory, DB connections
4. **Cost Tracking** - API costs, infrastructure costs

### Alerts
```
- API latency p95 > 500ms
- Error rate > 1%
- DB connection pool > 80%
- Disk usage > 85%
- Failed login attempts > 10/min (security)
```

---

## Cost Estimation

### Infrastructure (Monthly)
- **Kubernetes Cluster:** $50-100 (3 nodes)
- **PostgreSQL:** $25 (managed service)
- **Redis:** $15 (managed service)
- **Storage (S3/MinIO):** $10 (100GB)
- **Load Balancer:** $20
- **Monitoring:** Included (self-hosted)
- **Total:** ~$120-170/month

### LLM API Costs
- **OpenRouter (current):** $0 (using free tier)
- **Projected:** $10-50/month (paid tier for production)

### Total Estimated Cost
- **Development:** ~$50/month
- **Production (small scale):** ~$200-250/month
- **Production (growth):** Scales with usage

---

## Development Roadmap

### Phase 1: MVP Backend (Week 1-2)
- ✅ FastAPI project setup
- ✅ User authentication (JWT)
- ✅ Code review endpoint
- ✅ WebSocket real-time updates
- ✅ Integration with existing CLI core
- ✅ Database schema & migrations
- ✅ API documentation (OpenAPI)

### Phase 2: MVP Frontend (Week 3-4)
- ✅ React + TypeScript setup (Vite)
- ✅ Authentication UI (login/register)
- ✅ Code review page (Monaco editor)
- ✅ Real-time progress display
- ✅ Results visualization
- ✅ Basic dashboard

### Phase 3: Core Features (Week 5-6)
- ✅ Projects management
- ✅ Workflow history
- ✅ User settings
- ✅ OAuth integration (Google/GitHub)
- ✅ API key management
- ✅ Analytics dashboard

### Phase 4: Production Hardening (Week 7-8)
- ✅ Comprehensive testing (unit, integration, e2e)
- ✅ Security audit
- ✅ Performance optimization
- ✅ Monitoring setup
- ✅ Docker/K8s deployment
- ✅ CI/CD pipeline

### Phase 5: Beta Launch (Week 9-10)
- ✅ User feedback collection
- ✅ Bug fixes
- ✅ Documentation
- ✅ Video tutorials
- ✅ Marketing materials

---

## Success Metrics

### Technical KPIs
- API latency p95 < 500ms
- Uptime > 99.5%
- Error rate < 0.5%
- Frontend bundle < 300KB
- Time to Interactive < 2s

### Business KPIs
- 100 beta users in first month
- 1000 code reviews/month
- 80% user retention (30-day)
- NPS score > 50

---

## Next Steps

1. ✅ Codebase cleanup (COMPLETED)
2. ⏭️ **Implement FastAPI backend** (THIS STEP)
3. ⏭️ **Implement React frontend**
4. ⏭️ Integration testing
5. ⏭️ Production deployment

---

**Document Version:** 1.0
**Last Updated:** 2025-12-31
**Status:** Ready for Implementation

This architecture provides a solid foundation for a production-grade web application that enhances the existing CLI tool with a modern, scalable web interface.
